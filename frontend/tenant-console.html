<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StaunchBot Tenant Console</title>
  <style>
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f5f7fb;
      color: #0f172a;
    }
    .wrap {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .header {
      margin-bottom: 16px;
    }
    .header h1 {
      margin: 0 0 6px;
      font-size: 24px;
    }
    .header p {
      margin: 0;
      color: #475569;
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
    }
    .card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 8px 24px rgba(2, 6, 23, 0.05);
    }
    .card h2 {
      font-size: 16px;
      margin: 0 0 10px;
    }
    .row {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
    }
    label {
      font-size: 12px;
      color: #475569;
      font-weight: 600;
    }
    input, textarea {
      width: 100%;
      padding: 9px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
    }
    button {
      border: 0;
      border-radius: 8px;
      padding: 9px 12px;
      background: #0f766e;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button.alt {
      background: #334155;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .out {
      margin-top: 8px;
      font-size: 12px;
      background: #0b1220;
      color: #dbeafe;
      border-radius: 8px;
      padding: 10px;
      white-space: pre-wrap;
      min-height: 60px;
    }
    .small {
      font-size: 12px;
      color: #64748b;
    }
    .warn {
      color: #b45309;
    }
    .inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .inline > * {
      flex: 1 1 140px;
    }
    .table-wrap {
      overflow: auto;
      border: 1px solid #dbe3ee;
      border-radius: 8px;
      background: #fff;
      margin-top: 10px;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .kpi {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
      padding: 8px;
    }
    .kpi .k {
      font-size: 11px;
      color: #64748b;
    }
    .kpi .v {
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
      margin-top: 2px;
    }
    .thread-box {
      border: 1px solid #dbe3ee;
      border-radius: 8px;
      background: #fff;
      padding: 10px;
      max-height: 420px;
      overflow: auto;
      margin-top: 10px;
    }
    .msg {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
      padding: 8px;
      margin-bottom: 8px;
    }
    .msg .meta {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 6px;
    }
    .msg.user {
      background: #eff6ff;
      border-color: #bfdbfe;
    }
    .msg.assistant {
      background: #ecfeff;
      border-color: #a5f3fc;
    }
    .msg.agent {
      background: #f0fdf4;
      border-color: #bbf7d0;
    }
    .note {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
      padding: 8px;
      margin-bottom: 8px;
    }
    .note .meta {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 6px;
    }
    table.queue {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    table.queue th, table.queue td {
      border-bottom: 1px solid #eef2f7;
      padding: 8px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    table.queue th {
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    .tag {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid #dbe3ee;
      background: #f8fafc;
    }
    .tag.new { background: #ecfeff; color: #0f766e; border-color: #a5f3fc; }
    .tag.open { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
    .tag.pending_customer { background: #fff7ed; color: #c2410c; border-color: #fed7aa; }
    .tag.resolved { background: #ecfdf5; color: #15803d; border-color: #bbf7d0; }
    .tag.closed { background: #f1f5f9; color: #334155; border-color: #cbd5e1; }
    .row-action {
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 6px;
      border: 0;
      background: #334155;
      color: #fff;
      cursor: pointer;
    }
    select {
      width: 100%;
      padding: 9px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      background: #fff;
    }
    .sla-breach {
      background: #fff1f2;
    }
    .sla-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      color: #b91c1c;
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 999px;
      padding: 1px 6px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>StaunchBot Tenant Console</h1>
      <p>Self-serve onboarding and tenant operations without Swagger.</p>
    </div>

    <div class="grid">
      <section class="card">
        <h2>API + Session</h2>
        <div class="row">
          <label for="apiBase">API Base</label>
          <input id="apiBase" value="https://api.staunchbot.com" />
        </div>
        <div class="row">
          <label for="accessToken">Access Token</label>
          <textarea id="accessToken" placeholder="Bearer token will appear here"></textarea>
        </div>
        <button id="saveToken" class="alt">Save Token</button>
        <button id="clearToken" class="alt">Clear Token</button>
        <div class="small" style="margin-top:8px;">
          Token is stored in browser localStorage for this page only.
        </div>
      </section>

      <section class="card">
        <h2>Tenant Onboard</h2>
        <div class="row"><label>Tenant Name</label><input id="obTenantName" value="Demo Tenant Console" /></div>
        <div class="row"><label>Admin Email</label><input id="obAdminEmail" value="admin-console@demo.com" /></div>
        <div class="row"><label>Admin Password</label><input id="obAdminPassword" value="StrongPass123!" /></div>
        <div class="row"><label>Bot Name</label><input id="obBotName" value="Main Website Bot" /></div>
        <div class="row"><label>Allowed Origins (comma-separated)</label><input id="obAllowedOrigins" value="https://www.staunchbot.com,https://staunchbot.com" /></div>
        <button id="btnOnboard">Run Onboard</button>
        <div id="outOnboard" class="out"></div>
      </section>

      <section class="card">
        <h2>Tenant Login</h2>
        <div class="row"><label>Tenant ID</label><input id="lgTenantId" value="t_demo_3" /></div>
        <div class="row"><label>Email</label><input id="lgEmail" value="admin3@demo.com" /></div>
        <div class="row"><label>Password</label><input id="lgPassword" value="Abc12345!" /></div>
        <button id="btnLogin">Login</button>
        <div id="outLogin" class="out"></div>
      </section>

      <section class="card">
        <h2>Bots</h2>
        <button id="btnBots">Load Bots</button>
        <div id="outBots" class="out"></div>
        <div class="row" style="margin-top:10px;">
          <label>Bot ID for snippet</label>
          <input id="botId" placeholder="bot_..." />
        </div>
        <button id="btnSnippet" class="alt">Get Embed Snippet</button>
        <div id="outSnippet" class="out"></div>
      </section>

      <section class="card">
        <h2>Knowledge Upload + Reindex</h2>
        <div class="row">
          <label>Upload file (.txt, .md, .json, .pdf, .docx)</label>
          <input id="kgFile" type="file" />
        </div>
        <button id="btnUpload">Upload</button>
        <button id="btnStatus" class="alt">Check Status</button>
        <div id="outUpload" class="out"></div>
        <div class="row" style="margin-top:10px;">
          <label>Document ID to reindex</label>
          <input id="kgDocId" placeholder="d_..." />
        </div>
        <button id="btnReindex" class="alt">Reindex</button>
        <div id="outStatus" class="out"></div>
      </section>

      <section class="card">
        <h2>Inbox Queue (Handoff)</h2>
        <div class="row">
          <label>Status Filter</label>
          <select id="hfStatus">
            <option value="">(all)</option>
            <option value="new">new</option>
            <option value="open">open</option>
            <option value="pending_customer">pending_customer</option>
            <option value="resolved">resolved</option>
            <option value="closed">closed</option>
          </select>
        </div>
        <div class="row">
          <label>Assigned To Filter (user id)</label>
          <input id="hfAssignedTo" placeholder="u_admin_3" />
        </div>
        <div class="inline">
          <div class="row">
            <label>Priority Filter</label>
            <select id="hfPriorityFilter">
              <option value="">(all)</option>
              <option value="low">low</option>
              <option value="normal">normal</option>
              <option value="high">high</option>
              <option value="urgent">urgent</option>
            </select>
          </div>
          <div class="row">
            <label>SLA</label>
            <select id="hfBreachedOnly">
              <option value="false">all</option>
              <option value="true">breached only</option>
            </select>
          </div>
        </div>
        <div class="inline">
          <div class="row">
            <label>Sort</label>
            <select id="hfSort">
              <option value="priority_sla">priority + SLA</option>
              <option value="newest">newest first</option>
            </select>
          </div>
          <div class="row">
            <label>Auto-refresh</label>
            <select id="hfAutoRefresh">
              <option value="0">off</option>
              <option value="5">5s</option>
              <option value="10">10s</option>
              <option value="15">15s</option>
            </select>
          </div>
        </div>
        <button id="btnHandoffList">Load Queue</button>
        <div id="outHandoffList" class="out"></div>
        <div id="queueMetrics" class="kpi-grid" style="display:none;"></div>
        <div id="queueTableWrap" class="table-wrap" style="display:none;">
          <table class="queue" id="queueTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Source</th>
                <th>Assigned</th>
                <th>Created</th>
                <th>Question</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="queueTableBody"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>Handoff ID</label>
          <input id="hfId" placeholder="ho_..." />
        </div>
        <div class="inline">
          <div class="row">
            <label>Assign To (user id)</label>
            <input id="hfAssignTo" placeholder="u_admin_3" />
          </div>
          <div class="row">
            <label>Priority</label>
            <select id="hfPriority">
              <option value="">(no change)</option>
              <option value="low">low</option>
              <option value="normal">normal</option>
              <option value="high">high</option>
              <option value="urgent">urgent</option>
            </select>
          </div>
        </div>
        <div class="row">
          <label>Set Status</label>
          <select id="hfSetStatus">
            <option value="">(no change)</option>
            <option value="new">new</option>
            <option value="open">open</option>
            <option value="pending_customer">pending_customer</option>
            <option value="resolved">resolved</option>
            <option value="closed">closed</option>
          </select>
        </div>
        <div class="row">
          <label>Resolution Note</label>
          <input id="hfResolutionNote" placeholder="Resolved after customer confirmation." />
        </div>
        <button id="btnHandoffPatch" class="alt">Patch Handoff</button>
        <div id="outHandoffPatch" class="out"></div>

        <div class="row" style="margin-top:12px;">
          <label>Agent Actions (same handoff)</label>
          <div class="inline">
            <button id="btnHandoffClaim">Claim</button>
            <input id="hfClaimUser" placeholder="claim as user id (optional)" />
          </div>
        </div>
        <div class="row">
          <label>Agent Reply Message</label>
          <textarea id="hfAgentReply" placeholder="Write reply as agent..."></textarea>
        </div>
        <div class="inline">
          <div class="row">
            <label>Mark after reply</label>
            <select id="hfMarkPending">
              <option value="true">pending_customer</option>
              <option value="false">open</option>
            </select>
          </div>
          <div class="row" style="align-self:end;">
            <button id="btnHandoffReply" class="alt">Send Agent Reply</button>
          </div>
        </div>
        <div class="inline">
          <button id="btnPauseAI" class="alt">Pause AI</button>
          <button id="btnResumeAI" class="alt">Resume AI</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <label>Internal Note (private, agent only)</label>
          <textarea id="hfInternalNote" placeholder="Add private context for your team..."></textarea>
        </div>
        <div class="inline">
          <button id="btnAddInternalNote" class="alt">Add Internal Note</button>
          <button id="btnLoadNotes" class="alt">Load Notes</button>
        </div>
        <div id="outHandoffAgent" class="out"></div>
        <div id="notesTimeline" class="thread-box" style="display:none;"></div>

        <div class="row" style="margin-top:12px;">
          <label>Conversation ID</label>
          <div class="inline">
            <input id="convId" placeholder="conv_..." />
            <button id="btnLoadConversation" class="alt">Load Thread</button>
          </div>
          <div class="small">Selecting a queue row auto-fills this if available.</div>
        </div>
        <div id="outConversationMeta" class="out"></div>
        <div id="conversationThread" class="thread-box" style="display:none;"></div>
      </section>
    </div>

    <p class="small warn" style="margin-top:14px;">
      Use this console for development/admin flows. For production tenant UX, add proper auth UI, validation, and rate limiting.
    </p>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let queueTimer = null;

    function pretty(v) {
      try { return JSON.stringify(v, null, 2); } catch (_) { return String(v); }
    }

    function getApiBase() {
      return $("apiBase").value.trim().replace(/\/+$/, "");
    }

    function getToken() {
      return $("accessToken").value.trim();
    }

    function setToken(token) {
      $("accessToken").value = token || "";
    }

    async function request(path, options = {}) {
      const headers = Object.assign({}, options.headers || {});
      const token = getToken();
      if (token) headers.Authorization = `Bearer ${token.replace(/^Bearer\s+/i, "")}`;
      const res = await fetch(`${getApiBase()}${path}`, { ...options, headers });
      const text = await res.text();
      let data = text;
      try { data = JSON.parse(text); } catch (_) {}
      if (!res.ok) throw new Error(`${res.status} ${pretty(data)}`);
      return data;
    }

    function parseOrigins(s) {
      return String(s || "").split(",").map(v => v.trim()).filter(Boolean);
    }

    function esc(s) {
      return String(s == null ? "" : s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function shortDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString();
    }

    function renderQueueTable(items) {
      const wrap = $("queueTableWrap");
      const body = $("queueTableBody");
      body.innerHTML = "";
      if (!Array.isArray(items) || !items.length) {
        wrap.style.display = "none";
        return;
      }
      wrap.style.display = "block";
      for (const item of items) {
        const tr = document.createElement("tr");
        const statusClass = esc(item.status || "");
        const firstBreached = !!(item.first_response_due_at && !item.first_responded_at && ["new", "open"].includes(item.status));
        const resolutionBreached = !!(item.resolution_due_at && ["open", "pending_customer"].includes(item.status));
        const isBreached = firstBreached || resolutionBreached;
        if (isBreached) tr.className = "sla-breach";
        const breachBadges = [
          firstBreached ? '<span class="sla-badge">first response breached</span>' : "",
          resolutionBreached ? '<span class="sla-badge">resolution breached</span>' : "",
        ].filter(Boolean).join(" ");
        tr.innerHTML = `
          <td title="${esc(item.id)}">${esc(item.id || "-")}</td>
          <td><span class="tag ${statusClass}">${esc(item.status || "-")}</span>${breachBadges ? `<div style="margin-top:4px;">${breachBadges}</div>` : ""}</td>
          <td>${esc(item.priority || "-")}</td>
          <td>${esc(item.source_channel || "-")}</td>
          <td>${esc(item.assigned_to_user_id || "-")}</td>
          <td>${esc(shortDate(item.created_at))}</td>
          <td title="${esc(item.question || "")}" style="max-width:280px;white-space:normal;">${esc(item.question || "-")}</td>
          <td><button class="row-action" data-hid="${esc(item.id || "")}">Use</button></td>
        `;
        body.appendChild(tr);
      }
      body.querySelectorAll("button[data-hid]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const handoffId = btn.getAttribute("data-hid") || "";
          $("hfId").value = handoffId;
          const selected = (items || []).find((x) => x.id === handoffId);
          if (selected && selected.conversation_id) {
            $("convId").value = selected.conversation_id;
          }
          $("outHandoffAgent").textContent = `Selected handoff: ${$("hfId").value}`;
          $("btnLoadNotes").click();
        });
      });
    }

    function queueMetrics(items) {
      const rows = Array.isArray(items) ? items : [];
      const byStatus = { new: 0, open: 0, pending_customer: 0, resolved: 0, closed: 0 };
      let breached = 0;
      let unassigned = 0;
      for (const x of rows) {
        const s = String(x.status || "");
        if (Object.prototype.hasOwnProperty.call(byStatus, s)) byStatus[s] += 1;
        if (!x.assigned_to_user_id) unassigned += 1;
        if (isSlaBreached(x)) breached += 1;
      }
      return { total: rows.length, breached, unassigned, ...byStatus };
    }

    function renderQueueMetrics(items) {
      const box = $("queueMetrics");
      const m = queueMetrics(items);
      if (!m.total) {
        box.style.display = "none";
        box.innerHTML = "";
        return;
      }
      box.style.display = "grid";
      const cards = [
        ["Total", m.total],
        ["New", m.new],
        ["Open", m.open],
        ["Pending", m.pending_customer],
        ["Resolved", m.resolved],
        ["Closed", m.closed],
        ["Breached", m.breached],
        ["Unassigned", m.unassigned],
      ];
      box.innerHTML = cards.map(([k, v]) => `<div class="kpi"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`).join("");
    }

    function roleClass(role) {
      const r = String(role || "").toLowerCase();
      if (r === "user") return "user";
      if (r === "assistant") return "assistant";
      if (r === "agent") return "agent";
      return "";
    }

    function renderConversationThread(payload) {
      const box = $("conversationThread");
      if (!payload || !Array.isArray(payload.messages) || !payload.messages.length) {
        box.style.display = "none";
        box.innerHTML = "";
        return;
      }
      box.style.display = "block";
      box.innerHTML = payload.messages.map((m) => {
        const role = esc(m.role || "unknown");
        return `
          <div class="msg ${roleClass(m.role)}">
            <div class="meta">${role} â€¢ ${esc(shortDate(m.created_at))}</div>
            <div>${esc(m.content || "")}</div>
          </div>
        `;
      }).join("");
      box.scrollTop = box.scrollHeight;
    }

    function renderNotesTimeline(payload) {
      const box = $("notesTimeline");
      if (!payload || !Array.isArray(payload.items) || !payload.items.length) {
        box.style.display = "none";
        box.innerHTML = "";
        return;
      }
      box.style.display = "block";
      box.innerHTML = payload.items.map((n) => {
        return `
          <div class="note">
            <div class="meta">${esc(n.author_user_id || "-")} - ${esc(shortDate(n.created_at))}</div>
            <div>${esc(n.content || "")}</div>
          </div>
        `;
      }).join("");
      box.scrollTop = box.scrollHeight;
    }

    async function loadHandoffNotes() {
      const handoffId = $("hfId").value.trim();
      if (!handoffId) throw new Error("Provide handoff id.");
      const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}/notes?limit=200&offset=0`);
      renderNotesTimeline(data);
      return data;
    }

    function priorityRank(priority) {
      const p = String(priority || "").toLowerCase();
      if (p === "urgent") return 4;
      if (p === "high") return 3;
      if (p === "normal") return 2;
      if (p === "low") return 1;
      return 0;
    }

    function isSlaBreached(item) {
      const firstBreached = !!(item.first_response_due_at && !item.first_responded_at && ["new", "open"].includes(item.status));
      const resolutionBreached = !!(item.resolution_due_at && ["open", "pending_customer"].includes(item.status));
      return firstBreached || resolutionBreached;
    }

    function sortQueueItems(items) {
      const mode = $("hfSort").value;
      const arr = Array.isArray(items) ? [...items] : [];
      if (mode === "newest") {
        return arr.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      }
      return arr.sort((a, b) => {
        const breachDiff = Number(isSlaBreached(b)) - Number(isSlaBreached(a));
        if (breachDiff !== 0) return breachDiff;
        const prioDiff = priorityRank(b.priority) - priorityRank(a.priority);
        if (prioDiff !== 0) return prioDiff;
        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
      });
    }

    function setQueueAutoRefresh() {
      if (queueTimer) {
        clearInterval(queueTimer);
        queueTimer = null;
      }
      const seconds = parseInt($("hfAutoRefresh").value, 10) || 0;
      if (seconds > 0) {
        queueTimer = setInterval(() => {
          loadHandoffQueue(true);
        }, seconds * 1000);
      }
    }

    async function loadHandoffQueue(silent = false) {
      const out = $("outHandoffList");
      if (!silent) out.textContent = "Loading queue...";
      try {
        const params = new URLSearchParams();
        const status = $("hfStatus").value.trim();
        const assignedTo = $("hfAssignedTo").value.trim();
        const priority = $("hfPriorityFilter").value.trim();
        const breachedOnly = $("hfBreachedOnly").value === "true";
        if (status) params.set("status", status);
        if (assignedTo) params.set("assigned_to", assignedTo);
        if (priority) params.set("priority", priority);
        if (breachedOnly) params.set("breached_only", "true");
        const query = params.toString() ? `?${params.toString()}` : "";
        const data = await request(`/api/v1/admin/handoff${query}`);
        const items = sortQueueItems((data && data.items) || []);
        if (!silent) out.textContent = pretty({ ...data, items });
        renderQueueMetrics(items);
        renderQueueTable(items);
        if (items.length && items[0].id && !$("hfId").value.trim()) {
          $("hfId").value = items[0].id;
        }
      } catch (e) {
        out.textContent = String(e);
        renderQueueMetrics([]);
        renderQueueTable([]);
      }
    }

    $("saveToken").onclick = () => {
      localStorage.setItem("tenant_console_token", $("accessToken").value);
      localStorage.setItem("tenant_console_api_base", $("apiBase").value);
      alert("Saved.");
    };

    $("clearToken").onclick = () => {
      localStorage.removeItem("tenant_console_token");
      setToken("");
    };

    $("btnOnboard").onclick = async () => {
      const out = $("outOnboard");
      out.textContent = "Running...";
      try {
        const body = {
          tenant_name: $("obTenantName").value.trim(),
          admin_email: $("obAdminEmail").value.trim(),
          admin_password: $("obAdminPassword").value,
          compliance_level: "standard",
          bot_name: $("obBotName").value.trim(),
          allowed_origins: parseOrigins($("obAllowedOrigins").value),
        };
        const data = await request("/api/v1/tenant/onboard", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        out.textContent = pretty(data);
        if (data && data.access_token) setToken(data.access_token);
        if (data && data.bot_id) $("botId").value = data.bot_id;
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnLogin").onclick = async () => {
      const out = $("outLogin");
      out.textContent = "Running...";
      try {
        const body = {
          tenant_id: $("lgTenantId").value.trim(),
          email: $("lgEmail").value.trim(),
          password: $("lgPassword").value,
        };
        const data = await request("/api/v1/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        out.textContent = pretty(data);
        if (data && data.access_token) setToken(data.access_token);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnBots").onclick = async () => {
      const out = $("outBots");
      out.textContent = "Loading...";
      try {
        const data = await request("/api/v1/tenant/bots");
        out.textContent = pretty(data);
        if (Array.isArray(data) && data.length && data[0].id) {
          $("botId").value = data[0].id;
        }
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnSnippet").onclick = async () => {
      const out = $("outSnippet");
      out.textContent = "Loading...";
      try {
        const botId = $("botId").value.trim();
        if (!botId) throw new Error("Provide bot id first.");
        const data = await request(`/api/v1/tenant/embed/snippet?bot_id=${encodeURIComponent(botId)}`);
        out.textContent = data.snippet_html || pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnUpload").onclick = async () => {
      const out = $("outUpload");
      out.textContent = "Uploading...";
      try {
        const file = $("kgFile").files[0];
        if (!file) throw new Error("Pick a file first.");
        const fd = new FormData();
        fd.append("file", file);
        const data = await request("/api/v1/tenant/knowledge/upload", {
          method: "POST",
          body: fd,
        });
        out.textContent = pretty(data);
        if (data && data.document_id) $("kgDocId").value = data.document_id;
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnStatus").onclick = async () => {
      const out = $("outStatus");
      out.textContent = "Checking...";
      try {
        const data = await request("/api/v1/tenant/knowledge/status");
        out.textContent = pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnReindex").onclick = async () => {
      const out = $("outStatus");
      out.textContent = "Reindexing...";
      try {
        const docId = $("kgDocId").value.trim();
        if (!docId) throw new Error("Provide document id.");
        const data = await request("/api/v1/tenant/knowledge/reindex", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ document_id: docId }),
        });
        out.textContent = pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnHandoffList").onclick = () => loadHandoffQueue(false);
    $("hfAutoRefresh").onchange = () => setQueueAutoRefresh();
    $("hfSort").onchange = () => {
      if ($("queueTableWrap").style.display !== "none") loadHandoffQueue(true);
    };

    $("btnHandoffPatch").onclick = async () => {
      const out = $("outHandoffPatch");
      out.textContent = "Patching...";
      try {
        const handoffId = $("hfId").value.trim();
        if (!handoffId) throw new Error("Provide handoff id.");
        const body = {};
        const status = $("hfSetStatus").value.trim();
        const assignTo = $("hfAssignTo").value.trim();
        const priority = $("hfPriority").value.trim();
        const resolutionNote = $("hfResolutionNote").value.trim();
        if (status) body.status = status;
        if (assignTo) body.assigned_to_user_id = assignTo;
        if (priority) body.priority = priority;
        if (resolutionNote) body.resolution_note = resolutionNote;
        if (!Object.keys(body).length) throw new Error("Pick at least one field to update.");

        const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        out.textContent = pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnHandoffClaim").onclick = async () => {
      const out = $("outHandoffAgent");
      out.textContent = "Claiming...";
      try {
        const handoffId = $("hfId").value.trim();
        if (!handoffId) throw new Error("Provide handoff id.");
        const claimUser = $("hfClaimUser").value.trim();
        const body = {};
        if (claimUser) body.assigned_to_user_id = claimUser;
        const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}/claim`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        out.textContent = pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    };

    $("btnHandoffReply").onclick = async () => {
      const out = $("outHandoffAgent");
      out.textContent = "Sending agent reply...";
      try {
        const handoffId = $("hfId").value.trim();
        if (!handoffId) throw new Error("Provide handoff id.");
        const message = $("hfAgentReply").value.trim();
        if (!message) throw new Error("Write an agent reply message.");
        const markPendingCustomer = $("hfMarkPending").value === "true";
        const body = {
          message,
          mark_pending_customer: markPendingCustomer,
        };
        const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}/reply`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        out.textContent = pretty(data);
        $("hfAgentReply").value = "";
        if ($("convId").value.trim()) {
          $("btnLoadConversation").click();
        }
      } catch (e) {
        out.textContent = String(e);
      }
    };

    async function setAIToggle(aiPaused) {
      const out = $("outHandoffAgent");
      out.textContent = aiPaused ? "Pausing AI..." : "Resuming AI...";
      try {
        const handoffId = $("hfId").value.trim();
        if (!handoffId) throw new Error("Provide handoff id.");
        const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}/ai-toggle`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ai_paused: aiPaused }),
        });
        out.textContent = pretty(data);
      } catch (e) {
        out.textContent = String(e);
      }
    }

    $("btnPauseAI").onclick = () => setAIToggle(true);
    $("btnResumeAI").onclick = () => setAIToggle(false);
    $("btnAddInternalNote").onclick = async () => {
      const out = $("outHandoffAgent");
      out.textContent = "Saving internal note...";
      try {
        const handoffId = $("hfId").value.trim();
        if (!handoffId) throw new Error("Provide handoff id.");
        const note = $("hfInternalNote").value.trim();
        if (!note) throw new Error("Write an internal note first.");
        const data = await request(`/api/v1/admin/handoff/${encodeURIComponent(handoffId)}/notes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: note }),
        });
        $("hfInternalNote").value = "";
        out.textContent = pretty(data);
        await loadHandoffNotes();
      } catch (e) {
        out.textContent = String(e);
      }
    };
    $("btnLoadNotes").onclick = async () => {
      const out = $("outHandoffAgent");
      out.textContent = "Loading notes...";
      try {
        const data = await loadHandoffNotes();
        out.textContent = pretty({ handoff_id: data.handoff_id, count: data.count });
      } catch (e) {
        out.textContent = String(e);
        renderNotesTimeline(null);
      }
    };

    $("btnLoadConversation").onclick = async () => {
      const out = $("outConversationMeta");
      out.textContent = "Loading conversation...";
      try {
        const conversationId = $("convId").value.trim();
        if (!conversationId) throw new Error("Provide conversation id.");
        const data = await request(
          `/api/v1/admin/conversations/${encodeURIComponent(conversationId)}/messages?limit=200&offset=0`
        );
        out.textContent = `Conversation: ${data.conversation_id}\nMessages: ${Array.isArray(data.messages) ? data.messages.length : 0}`;
        renderConversationThread(data);
      } catch (e) {
        out.textContent = String(e);
        renderConversationThread(null);
      }
    };

    (function bootstrap() {
      const savedToken = localStorage.getItem("tenant_console_token");
      const savedBase = localStorage.getItem("tenant_console_api_base");
      if (savedToken) setToken(savedToken);
      if (savedBase) $("apiBase").value = savedBase;
      setQueueAutoRefresh();
    })();
  </script>
</body>
</html>

